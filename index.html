<!DOCTYPE html>
<html lang="en"> <!-- Dil İngilizce olarak güncellendi -->
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JaguarBet - Live Scores & Stats</title> <!-- Başlık İngilizce olarak güncellendi -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* MEVCUT TÜM CSS KODU */
        :root { --primary-color: #D32F2F; --primary-hover-color: #B71C1C; --live-text-color: #D32F2F; --favorite-color: #ffc107; --goal-flash-bg: #D32F2F; --background-color: #121212; --surface-color: #1E1E1E; --surface-highlight-color: #2A2A2A; --text-color: #E0E0E0; --text-muted-color: #B0B0B0; --border-color: #333333; --danger-color: #FF4D4D; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background: var(--background-color); color: var(--text-color); line-height: 1.5; font-size: 15px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        header { display: flex; justify-content: space-between; align-items: center; background: var(--surface-color); padding: 1rem; font-size: 1.8rem; font-family: 'Orbitron', sans-serif; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); box-shadow: 0 4px 12px rgba(211, 47, 47, 0.1); }
        #auth-section button, .form-group button, .card button { background: var(--primary-color); color: white; border:none; padding: 8px 12px; font-size: 0.9rem; border-radius: 5px; cursor: pointer; margin-left: 10px; font-weight: bold; transition: background-color 0.2s; }
        .tabs { display: flex; background-color: var(--surface-highlight-color); border-bottom: 1px solid var(--border-color); overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-button { padding: 0.8rem 1.2rem; cursor: pointer; border: none; background-color: transparent; color: var(--text-muted-color); font-size: 0.9rem; font-weight: 500; transition: all 0.25s ease-in-out; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 700; }
        .tab-button:hover:not(.active) { color: var(--text-color); background-color: rgba(255,255,255,0.05); }
        .tab-content { display: none; padding-top: 1rem; }
        .tab-content.active { display: block; }
        .card { background: var(--surface-color); padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-bottom: 1.5rem; border: 1px solid var(--border-color); }
        .card-header { font-size: 1.25rem; margin: -1.5rem -1.5rem 1.5rem; padding: 1rem 1.5rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); background-color: var(--surface-highlight-color); border-radius: 8px 8px 0 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 0.4rem; font-weight: 500; font-size: 0.85rem; color: var(--text-muted-color); }
        .form-group select, .form-group input, input[type="date"] { padding: 0.7rem 0.8rem; background-color: var(--surface-highlight-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; font-family: inherit; font-size: 0.9rem; width: 100%; -webkit-appearance: none; }
        .form-group input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        .card button:hover, .form-group button:hover { background-color: var(--primary-hover-color); }
        .league-group-header { display: flex; align-items: center; padding: 0.7rem 1rem; background-color: var(--surface-highlight-color); border-radius: 6px 6px 0 0; margin-top: 1.2rem; border-bottom: 1px solid var(--border-color); }
        .league-group-header:first-child { margin-top: 0; }
        .league-flag { width: 22px; height: auto; margin-right: 10px; border-radius: 3px; object-fit: cover; }
        .league-info .league-name { font-size: 1rem; font-weight: 700; color: var(--text-color); }
        .league-info .country-name { font-size: 0.8rem; color: var(--text-muted-color); }
        .match-row { display: flex; align-items: center; padding: 0.8rem 1rem; border-bottom: 1px solid var(--border-color); background-color: var(--surface-color); transition: background-color 0.2s ease; position: relative; overflow: hidden; cursor: pointer; }
        .league-matches .match-row:last-child { border-bottom: none; border-radius: 0 0 6px 6px; }
        .match-row:hover { background-color: var(--surface-highlight-color); }
        .match-status { font-size: 0.85rem; color: var(--text-muted-color); font-weight: 500; width: 60px; text-align: center; margin-right: 0.8rem; flex-shrink: 0;}
        .match-teams { flex-grow: 1; margin-right: 0.8rem; }
        .team-line { display: flex; align-items: center; margin-bottom: 0.3rem; }
        .team-line:last-child { margin-bottom: 0; }
        .team-logo { width: 18px; height: 18px; margin-right: 8px; object-fit: contain; }
        .team-name { font-size: 0.9rem; color: var(--text-color); }
        .match-scores { display: flex; flex-direction: column; align-items: center; width: 25px; font-weight: 700; }
        .score-value { font-size: 1rem; color: var(--text-color); }
        .favorite-toggle { cursor: pointer; font-size: 1.4rem; line-height: 1; color: #555; transition: color 0.2s, transform 0.2s; margin-left: 1rem; padding: 5px; user-select: none; z-index: 2; }
        .favorite-toggle:hover { transform: scale(1.2); }
        .favorite-toggle.is-favorite { color: var(--favorite-color); }
        .favorite-toggle.favorite-animate { animation: favorite-pop 0.3s ease-in-out; }
        @keyframes favorite-pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
        #loading-indicator, .content-loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.85); color: var(--primary-color); padding: 20px 30px; border-radius: 10px; font-size: 1rem; z-index: 2000; display: none; text-align: center; flex-direction: column; align-items: center; justify-content: center; }
        .content-loader { position: static; transform: none; background: transparent; padding: 2rem; }
        .loader { border: 4px solid #f3f3f330; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 28px; height: 28px; animation: spin 1s linear infinite; margin: 0 auto 8px auto; }
        #favorite-alert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--surface-color); color: var(--primary-color); border: 1px solid var(--primary-color); border-radius: 8px; padding: 12px 32px; font-size: 1rem; z-index: 3000; box-shadow: 0 4px 16px rgba(0,0,0,0.15); display: none; opacity: 0; transition: opacity 0.3s; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        th, td { text-align: left; padding: 0.8rem; border-bottom: 1px solid var(--border-color); }
        th { background-color: var(--surface-highlight-color); font-weight: 700; color: var(--primary-color); }
        tbody tr:hover { background-color: var(--surface-highlight-color); }
        td img { width: 20px; height: 20px; margin-right: 8px; vertical-align: middle; }
        #profile-button { display: flex; align-items: center; gap: 8px; background-color: transparent; border: 1px solid var(--border-color); padding: 6px 12px; font-size: 0.9rem; font-family: 'Roboto', sans-serif; font-weight: 500; cursor: pointer; }
        #profile-caret { font-size: 0.7em; transition: transform 0.2s ease-in-out; }
        #profile-button.open #profile-caret { transform: rotate(180deg); }
        #profile-menu { position: absolute; top: 100%; right: 0; margin-top: 10px; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; width: 280px; box-shadow: 0 8px 16px rgba(0,0,0,0.3); z-index: 100; overflow: hidden; display: none; font-family: 'Roboto', sans-serif; font-size: 15px; }
        .profile-menu-header { padding: 1rem; border-bottom: 1px solid var(--border-color); background-color: var(--surface-highlight-color); }
        #menu-user-name { font-weight: 700; color: var(--text-color); }
        #menu-user-email { font-size: 0.85rem; color: var(--text-muted-color); word-break: break-all; }
        .profile-menu-item { padding: 0.8rem 1rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .profile-menu-item strong { color: var(--text-muted-color); margin-right: 5px; }
        #menu-wallet-address { font-family: monospace; font-size: 0.8rem; background: var(--background-color); padding: 2px 5px; border-radius: 4px; word-break: break-all; }
        .profile-menu-value { font-weight: 700; color: var(--primary-color); }
        .profile-menu-link { display: block; padding: 0.8rem 1rem; text-align: center; background-color: var(--primary-hover-color); color: white; text-decoration: none; font-weight: 700; transition: background-color 0.2s; }
        .profile-menu-link:hover { background-color: var(--primary-color); }
        .notification-toggle-label { cursor: pointer; user-select: none; }
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-container { background: var(--surface-color); width: 95%; max-width: 800px; max-height: 90vh; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border-color); }
        .modal-header { padding: 1rem 1.5rem; background: var(--surface-highlight-color); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-size: 1.1rem; font-weight: 700; color: var(--primary-color); }
        .modal-close { font-size: 1.8rem; color: var(--text-muted-color); cursor: pointer; background: none; border: none; padding: 0; line-height: 1; }
        .modal-body { overflow-y: auto; padding: 1.5rem; }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin: -1.5rem -1.5rem 1.5rem; padding: 0 1.5rem; }
        .modal-tab-button { padding: 1rem 0.5rem; margin-right: 1.5rem; cursor: pointer; border: none; background: transparent; color: var(--text-muted-color); border-bottom: 3px solid transparent; font-size: 0.9rem; font-weight: 500; }
        .modal-tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }
        .event-row { display: flex; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
        .event-row:last-child { border-bottom: none; }
        .event-time { font-weight: 700; width: 50px; text-align: center; }
        .event-icon { margin: 0 1rem; width: 20px; text-align: center; display:flex; justify-content:center; align-items:center; }
        .event-details { flex-grow: 1; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 0.9rem; }
        .stat-title { text-align:center; margin-bottom:0.5rem; font-weight:bold; color: var(--text-muted-color); }
        .stat-bar-container { display: flex; align-items: center; margin: 0 1rem; }
        .stat-bar-wrapper { flex-grow: 1; height: 8px; background-color: var(--surface-highlight-color); border-radius: 4px; display: flex; }
        .stat-bar { height: 100%; border-radius: 4px; }
        .lineup-container { display: flex; justify-content: space-between; gap: 2rem; }
        .lineup-team { width: 50%; }
        .lineup-team h4 { margin-bottom: 1rem; text-align: center; color: var(--primary-color); }
        .lineup-team h5 { margin-top:1.5rem; margin-bottom:0.5rem; font-size:0.95rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3rem;}
        .player-row { display: flex; align-items: center; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .h2h-match-row { border-bottom: 1px solid var(--border-color); padding: 0.8rem 0; }
        .h2h-match-row:last-child { border-bottom: none; }
        .h2h-teams { display: flex; justify-content: space-between; font-size: 0.9rem; align-items:center; }
        .h2h-score { font-weight: bold; padding: 0 1rem; }
        .h2h-date { font-size: 0.8rem; color: var(--text-muted-color); text-align: center; margin-top: 0.3rem; }
        
        /* --- YENİ EKLENEN PREDICTION MARKET STYLES --- */
        .prediction-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .prediction-section h4 { color: var(--primary-color); margin-bottom: 1rem; font-size: 1.1rem; }
        .prediction-form .form-grid { grid-template-columns: 1fr 1fr 100px auto; gap: 1rem; align-items: end; }
        .prediction-form .form-group { margin-bottom: 0; }
        .btn-create-prediction { background-color: #4CAF50; padding: 10px 15px !important; font-size: 0.9rem !important; }
        .btn-create-prediction:hover { background-color: #45a049; }
        .prediction-list .prediction-item { background: var(--surface-highlight-color); padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid var(--favorite-color); }
        .prediction-list .prediction-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
        .prediction-list .prediction-creator { font-size: 0.8rem; color: var(--text-muted-color); word-break: break-all; }
        .prediction-list .prediction-details { font-size: 1rem; font-weight: 500; margin-bottom: 1rem; }
        .prediction-list .prediction-meta { display: flex; justify-content: space-between; align-items: center; }
        .prediction-list .prediction-meta span { font-size: 0.9rem; }
        .btn-join-prediction { background-color: var(--primary-color); padding: 8px 15px; font-size: 0.9rem; }
        .btn-join-prediction:disabled { background-color: #555; cursor: not-allowed; }
        #prediction-status { margin-top: 1rem; text-align: center; padding: 10px; border-radius: 5px; display: none; }
    </style>
</head>
<body>
    <header>
        <span>⚽ JaguarBet</span>
        <div id="auth-section">
            <button id="google-login-btn">Log in with Google</button>
            <button id="wallet-login-btn">Log in with Wallet</button>
            <span id="login-loading" style="display:none; margin-left:10px; color:var(--primary-color); font-size:1.1rem; vertical-align:middle;">⏳</span>
            <div id="login-message" style="margin-top:0.5rem; font-size:0.95rem;"></div>
        </div>
        <div id="profile-section" style="display: none; position: relative;">
            <button id="profile-button">
                <span id="profile-name"></span>
                <span id="profile-caret">▼</span>
            </button>
            <div id="profile-menu" style="display: none;">
                <div class="profile-menu-header">
                    <div style="font-size:1.1rem; color:var(--primary-color); font-weight:bold; margin-bottom:0.3rem;">Welcome!</div>
                    <div id="menu-user-name"></div>
                    <div id="menu-user-email"></div>
                </div>
                <div class="profile-menu-item" id="menu-wallet-address-container" style="display: none;">
                    <strong>Wallet Address:</strong>
                    <span id="menu-wallet-address"></span>
                </div>
                <div class="profile-menu-item">
                    <span>Free Coupons:</span>
                    <span class="profile-menu-value">0</span>
                </div>
                <div class="profile-menu-item">
                    <span>Earned Tokens:</span>
                    <span class="profile-menu-value">0</span>
                </div>
                <div class="profile-menu-item" id="notification-item" style="display: none;">
                    <label for="notification-switch" class="notification-toggle-label">Notifications</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notification-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                <a href="#" class="profile-menu-link" id="logout-btn">Log Out</a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab-button active" data-tab="live-scores-tab">Live Scores</button>
            <button class="tab-button" data-tab="scheduled-tab">Scheduled</button>
            <button class="tab-button" data-tab="finished-tab">Finished</button>
            <button class="tab-button" data-tab="favorites-tab">⭐ My Favorites</button>
            <button class="tab-button" data-tab="standings-tab">Standings</button>
        </div>

        <div id="live-scores-tab" class="tab-content active"><div id="live-matches-container"></div></div>

        <div id="scheduled-tab" class="tab-content">
            <div class="card">
                <div class="card-header">Fixtures by Date</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="scheduled-date-select">Date</label>
                        <input type="date" id="scheduled-date-select">
                    </div>
                    <div class="form-group">
                        <button onclick="fetchFixtures('scheduled')">Show Fixtures</button>
                    </div>
                </div>
            </div>
            <div id="scheduled-matches-container">
                 <div class="content-loader">Please select a date and click "Show Fixtures".</div>
            </div>
        </div>

        <div id="finished-tab" class="tab-content">
            <div class="card">
                <div class="card-header">Results by Date</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="finished-date-select">Date</label>
                        <input type="date" id="finished-date-select">
                    </div>
                    <div class="form-group">
                        <button onclick="fetchFixtures('finished')">Show Results</button>
                    </div>
                </div>
            </div>
            <div id="finished-matches-container">
                 <div class="content-loader">Please select a date and click "Show Results".</div>
            </div>
        </div>

        <div id="favorites-tab" class="tab-content"><div id="favorite-matches-container"></div></div>
        
        <div id="standings-tab" class="tab-content">
            <div class="card">
                <div class="card-header">League Standings</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="league-select">League</label>
                        <select id="league-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="season-select">Season</label>
                        <select id="season-select"></select>
                    </div>
                    <div class="form-group">
                        <button onclick="fetchStandings()">Show</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="standings-table" style="display:none">
                        <thead><tr><th style="width:40px">#</th><th style="text-align:left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th><th>Form</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="standings-message" class="content-loader">Please select a league and season.</div>
            </div>
        </div>
    </div>
    
    <div id="fixture-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <div id="modal-title" class="modal-title"></div>
                <button id="modal-close-btn" class="modal-close">×</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>
    
    <div id="loading-indicator"><div class="loader"></div>Loading Data...</div>
    <div id="favorite-alert"></div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="analytics.js"></script>
    
    <script>
        // MEVCUT KODUN BAŞLANGICI
        const API_BASE_AUTH = '/api/auth';
        const API_BASE_FOOTBALL = '/api/football';
        const API_BASE_NOTIFICATIONS = '/api/notifications';
        const API_BASE_PREDICTIONS = '/api/predictions'; // YENİ EKLENDİ
        const API_BASE_CONFIG = '/api/config';
        
        let FCM_VAPID_PUBLIC_KEY = null;
        let userDbFavorites = new Set();
        let currentUser = null;
        let allMatchesData = {};
        let liveMatchIntervalId = null;
        const loadingIndicator = document.getElementById('loading-indicator');
        const modal = document.getElementById('fixture-modal');
        const modalBody = document.getElementById('modal-body');
        const modalTitle = document.getElementById('modal-title');

        // --- HELPER FUNCTIONS ---
        const getGuestFavorites = () => new Set(JSON.parse(localStorage.getItem('guest_favorites') || '[]').map(Number));
        const saveGuestFavorites = (favsSet) => localStorage.setItem('guest_favorites', JSON.stringify(Array.from(favsSet)));
        const getCurrentFavorites = () => currentUser ? userDbFavorites : getGuestFavorites();
        const showLoading = () => loadingIndicator.style.display = 'flex';
        const hideLoading = () => loadingIndicator.style.display = 'none';
        const displayMessage = (containerId, message, isError = false) => {
            const container = document.getElementById(containerId);
            if (container) container.innerHTML = `<div class="content-loader" style="color: ${isError ? 'var(--danger-color)' : 'var(--text-muted-color)'};">${message}</div>`;
        };
        const parseJwt = (token) => { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } };
        const urlBase64ToUint8Array = (base64String) => {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
            return outputArray;
        };
        
        const fetchDataFromBackend = async (endpoint, options = {}) => {
            if (typeof JaguarAnalytics !== 'undefined') {
                JaguarAnalytics.logRequest(endpoint);
            }
            const response = await fetch(endpoint, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'An unknown error occurred' }));
                throw new Error(errorData.error || `API Error: ${response.status}`);
            }
            return response.json();
        };

        // --- RENDER FUNCTIONS ---
        const createLeagueHeaderElement = (league) => `
            <div class="league-group-header">
                <img src="${league.logo}" alt="${league.country}" class="league-flag">
                <div class="league-info">
                    <div class="league-name">${league.name}</div>
                    <div class="country-name">${league.country}</div>
                </div>
            </div>`;

        const createFixtureRowElement = (match) => {
            const { fixture, teams, goals } = match;
            allMatchesData[fixture.id] = match;
            const favorites = getCurrentFavorites();
            
            let statusText;
            const shortStatus = fixture.status.short;
            const statusMap = {'FT':'Finished', 'AET':'Finished (AET)', 'PEN':'Finished (PEN)', 'CANC':'Cancelled', 'ABD':'Abandoned', 'PST':'Postponed', 'AWD': 'Awarded', 'WO': 'Walkover'};

            if (statusMap[shortStatus]) {
                statusText = statusMap[shortStatus];
            } else if (fixture.status.elapsed) {
                statusText = `<span style="color:var(--live-text-color);">${fixture.status.elapsed}'</span>`;
            } else {
                statusText = new Date(fixture.date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }

            return `
                <div class="match-row" id="match-${fixture.id}" onclick="showFixtureDetails(${fixture.id})">
                    <div class="match-status">${statusText}</div>
                    <div class="match-teams">
                        <div class="team-line"><img src="${teams.home.logo}" class="team-logo" alt="${teams.home.name}">${teams.home.name}</div>
                        <div class="team-line"><img src="${teams.away.logo}" class="team-logo" alt="${teams.away.name}">${teams.away.name}</div>
                    </div>
                    <div class="match-scores">
                        <div class="score-value">${goals.home ?? '-'}</div>
                        <div class="score-value">${goals.away ?? '-'}</div>
                    </div>
                    <span class="favorite-toggle ${favorites.has(fixture.id) ? 'is-favorite' : ''}" data-fixture-id="${fixture.id}" onclick="toggleFavorite('${fixture.id}', event)">★</span>
                </div>`;
        };
        
        const renderFixtures = (container, matches, type) => {
            const messageMap = {
                'live': 'No live matches right now.',
                'scheduled': 'No scheduled matches found for the selected date.',
                'finished': 'No finished matches found for the selected date.',
                'favorites': 'You have no favorite matches yet.'
            };
            if (!matches || matches.length === 0) {
                displayMessage(container.id, messageMap[type] || 'No data found.');
                return;
            }

            const groupedByLeague = matches.reduce((acc, match) => {
                (acc[match.league.id] = acc[match.league.id] || []).push(match);
                return acc;
            }, {});
            
            const sortedLeagueIds = Object.keys(groupedByLeague).sort((a,b) => (groupedByLeague[a][0].league.name || '').localeCompare(groupedByLeague[b][0].league.name || ''));
            
            let html = '';
            for (const leagueId of sortedLeagueIds) {
                const leagueMatches = groupedByLeague[leagueId].sort((a,b) => new Date(a.fixture.date) - new Date(b.fixture.date));
                html += createLeagueHeaderElement(leagueMatches[0].league);
                html += leagueMatches.map(createFixtureRowElement).join('');
            }
            container.innerHTML = html;
        };

        // --- FETCH LOGIC ---
        const fetchLiveMatches = async (isUpdate = false) => {
            if (!isUpdate) showLoading();
            try {
                const data = await fetchDataFromBackend(`${API_BASE_FOOTBALL}/fixtures?live=all`);
                renderFixtures(document.getElementById('live-matches-container'), data.response, 'live');
                renderFavoriteMatches();
            } catch (error) {
                console.error("Error fetching live matches:", error);
                displayMessage('live-matches-container', 'Could not load live matches.', true);
            } finally {
                if (!isUpdate) hideLoading();
                updateAllFavoriteIcons();
            }
        };

        const fetchFixtures = async (type) => {
            const dateInput = document.getElementById(`${type}-date-select`);
            const container = document.getElementById(`${type}-matches-container`);
            const date = dateInput.value;
            if (!date) {
                showFavoriteAlert('Please select a date.');
                return;
            }
            container.innerHTML = `<div class="content-loader"><div class="loader"></div>Loading data...</div>`;
            try {
                const data = await fetchDataFromBackend(`${API_BASE_FOOTBALL}/fixtures?date=${date}`);
                
                const finishedStatus = ['FT', 'AET', 'PEN', 'CANC', 'ABD', 'PST', 'AWD', 'WO'];
                const matches = (type === 'finished')
                    ? data.response.filter(m => finishedStatus.includes(m.fixture.status.short))
                    : data.response.filter(m => !finishedStatus.includes(m.fixture.status.short));
                
                renderFixtures(container, matches, type);
            } catch (error) {
                console.error(`Error fetching ${type} fixtures:`, error);
                displayMessage(container.id, 'Could not load data.', true);
            }
        };

        const renderFavoriteMatches = () => {
            const container = document.getElementById('favorite-matches-container');
            const favorites = getCurrentFavorites();
            if (favorites.size === 0) {
                displayMessage('favorite-matches-container', 'You have no favorite matches yet.<br>Click the star next to a match to add it.');
                return;
            }
            const favoriteMatches = Array.from(favorites).map(id => allMatchesData[id]).filter(Boolean);
            renderFixtures(container, favoriteMatches, 'favorites');
        };

        // --- MODAL FUNCTIONS ---
        const openModal = () => modal.style.display = 'flex';
        const closeModal = () => modal.style.display = 'none';

        const showFixtureDetails = async (fixtureId) => {
            openModal();
            modalBody.innerHTML = `<div class="content-loader"><div class="loader"></div>Loading Details...</div>`;
        
            try {
                const fixtureDataResponse = await fetchDataFromBackend(`${API_BASE_FOOTBALL}/fixture-details?id=${fixtureId}`);
                const fixtureData = fixtureDataResponse.response[0];
                if (!fixtureData) { throw new Error('Fixture details not found.'); }
                allMatchesData[fixtureId] = fixtureData;
                const h2hData = await fetchDataFromBackend(`${API_BASE_FOOTBALL}/h2h?h2h=${fixtureData.teams.home.id}-${fixtureData.teams.away.id}`);
                modalTitle.textContent = `${fixtureData.teams.home.name} vs ${fixtureData.teams.away.name}`;
                renderModalContent(fixtureData, h2hData.response);
            } catch (error) {
                console.error("Error fetching details:", error);
                modalBody.innerHTML = `<div class="content-loader" style="color:var(--danger-color)">Could not load details.</div>`;
            }
        };

        // GÜNCELLENMİŞ renderModalContent FONKSİYONU
        const renderModalContent = (fixture, h2h) => {
            const isFinished = ['FT', 'AET', 'PEN'].includes(fixture.fixture.status.short);
            const hasStarted = !!fixture.fixture.status.elapsed || isFinished;
        
            const renderPredictionMarket = (fixtureId) => {
                let createHtml = '';
                if (!hasStarted && !isFinished) {
                    createHtml = `
                        <h4>Create New Prediction</h4>
                        <div class="prediction-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="market-type">Market</label>
                                    <select id="market-type">
                                        <option value="TOTAL_GOALS:OVER_2_5">Total Goals - Over 2.5</option>
                                        <option value="TOTAL_GOALS:UNDER_2_5">Total Goals - Under 2.5</option>
                                        <option value="BOTH_TEAMS_SCORE:YES">Both Teams to Score - Yes</option>
                                        <option value="BOTH_TEAMS_SCORE:NO">Both Teams to Score - No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="entry-fee">Entry Fee (JAG)</label>
                                    <input type="number" id="entry-fee" value="10" min="1">
                                </div>
                                <div class="form-group">
                                    <label for="max-participants">Max Users</label>
                                    <input type="number" id="max-participants" value="20" min="2">
                                </div>
                                <div class="form-group">
                                     <button class="btn-create-prediction" onclick="createPrediction(${fixtureId})">Create</button>
                                </div>
                            </div>
                        </div>
                        <div id="prediction-status" style="display:none;"></div>
                    `;
                }

                return `
                    <div class="prediction-section">
                        ${createHtml}
                        <h4 style="margin-top: ${createHtml ? '2rem' : '0'};">Active Predictions for this Match</h4>
                        <div class="prediction-list" id="prediction-list-container">
                            <div class="content-loader">Loading predictions...</div>
                        </div>
                    </div>
                `;
            };

            let tabsHTML = '';
            let contentHTML = '';
            
            const addTab = (id, label, content, isActive = false) => {
                tabsHTML += `<button class="modal-tab-button ${isActive ? 'active' : ''}" data-tab="${id}">${label}</button>`;
                contentHTML += `<div id="${id}-content" class="modal-tab-content ${isActive ? 'active' : ''}">${content}</div>`;
            };

            let firstTab = true;
            
            if (hasStarted || isFinished) {
                addTab('summary', 'Summary', renderSummary(fixture.events, fixture.teams), firstTab);
                firstTab = false;
            }
            if (isFinished) {
                addTab('stats', 'Statistics', renderStats(fixture.statistics, fixture.teams), firstTab && !hasStarted);
                firstTab = false;
            }
            addTab('lineups', 'Lineups', renderLineups(fixture.lineups, fixture.fixture.id), firstTab);
            firstTab = false;
            addTab('h2h', 'H2H', renderH2H(h2h), firstTab);
            firstTab = false;
            
            addTab('predictions', 'Prediction Market', renderPredictionMarket(fixture.fixture.id), firstTab);

            modalBody.innerHTML = `<div class="modal-tabs">${tabsHTML}</div>${contentHTML}`;
            
            modalBody.querySelectorAll('.modal-tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabId = e.target.dataset.tab + '-content';
                    modalBody.querySelectorAll('.modal-tab-content, .modal-tab-button').forEach(el => el.classList.remove('active'));
                    e.target.classList.add('active');
                    const contentEl = modalBody.querySelector('#' + tabId);
                    if (contentEl) contentEl.classList.add('active');

                    if (e.target.dataset.tab === 'predictions') {
                        loadPredictionsForFixture(fixture.fixture.id);
                    }
                });
            });

            const activeTabButton = modalBody.querySelector('.modal-tab-button.active');
            if (activeTabButton && activeTabButton.dataset.tab === 'predictions') {
                loadPredictionsForFixture(fixture.fixture.id);
            }
        };

        const getEventIcon = (type, detail) => {
            if (type === 'Goal') {
                if (detail === 'Own Goal') return '⚽ <small>(OG)</small>';
                if (detail === 'Penalty') return '⚽ <small>(P)</small>';
                return '⚽';
            }
            if (type === 'Card') {
                if (detail === 'Yellow Card') return '<div style="width:12px;height:16px;background:yellow;border:1px solid #ccc;"></div>';
                if (detail === 'Red Card') return '<div style="width:12px;height:16px;background:red;border:1px solid #ccc;"></div>';
            }
            if (type === 'subst') return '🔄';
            if (type === 'Var') return '📺';
            return '';
        };

        const renderSummary = (events, teams) => {
            if (!events || events.length === 0) return '<p style="text-align:center;padding:2rem;color:var(--text-muted-color);">Match summary not available.</p>';
            return events.map(event => `
                <div class="event-row" style="flex-direction: ${event.team.id === teams.home.id ? 'row' : 'row-reverse'}">
                    <div class="event-time">${event.time.elapsed}'</div>
                    <div class="event-icon">${getEventIcon(event.type, event.detail)}</div>
                    <div class="event-details" style="text-align:${event.team.id === teams.home.id ? 'left' : 'right'}"><strong>${event.player.name}</strong><br><small>${event.assist.name ? 'Assist: ' + event.assist.name : ''}</small></div>
                </div>
            `).join('');
        };

        const renderStats = (stats, teams) => {
            if (!stats || stats.length < 2) return '<p style="text-align:center;padding:2rem;color:var(--text-muted-color);">Statistics not available.</p>';
            const homeStats = stats.find(s => s.team.id === teams.home.id)?.statistics || [];
            const awayStats = stats.find(s => s.team.id === teams.away.id)?.statistics || [];
            const statTypes = [...new Set([...homeStats.map(s => s.type), ...awayStats.map(s => s.type)])];

            return statTypes.map(type => {
                const homeValue = homeStats.find(s => s.type === type)?.value || 0;
                const awayValue = awayStats.find(s => s.type === type)?.value || 0;
                const total = (parseInt(String(homeValue).replace('%','')) || 0) + (parseInt(String(awayValue).replace('%','')) || 0);
                const homeWidth = total > 0 ? ((parseInt(String(homeValue).replace('%','')) || 0) / total) * 100 : 50;

                return `
                    <div class="stat-title">${type}</div>
                    <div class="stat-row">
                        <span>${homeValue ?? '0'}</span>
                        <div class="stat-bar-container">
                            <div class="stat-bar-wrapper">
                                <div class="stat-bar" style="width: ${homeWidth}%; background: var(--text-color);"></div>
                                <div class="stat-bar" style="width: ${100 - homeWidth}%; background: var(--primary-color);"></div>
                            </div>
                        </div>
                        <span>${awayValue ?? '0'}</span>
                    </div>`;
            }).join('');
        };

        const renderLineups = (lineups, fixtureId) => {
            if (!lineups || lineups.length < 2) return '<p style="text-align:center;padding:2rem;color:var(--text-muted-color);">Lineups not announced yet.</p>';
            const homeLineup = lineups.find(l => l.team.id === allMatchesData[fixtureId].teams.home.id) || lineups[0];
            const awayLineup = lineups.find(l => l.team.id === allMatchesData[fixtureId].teams.away.id) || lineups[1];
            
            return `
                <div class="lineup-container">
                    <div class="lineup-team">
                        <h4>${homeLineup.team.name} (${homeLineup.formation || 'N/A'})</h4>
                        <h5>Starting XI</h5>
                        ${homeLineup.startXI.map(p => `<div class="player-row">${p.player.number || '-'}. ${p.player.name}</div>`).join('')}
                        <h5 style="margin-top:1rem;">Substitutes</h5>
                        ${homeLineup.substitutes.map(p => `<div class="player-row">${p.player.number || '-'}. ${p.player.name}</div>`).join('')}
                    </div>
                    <div class="lineup-team">
                        <h4>${awayLineup.team.name} (${awayLineup.formation || 'N/A'})</h4>
                        <h5>Starting XI</h5>
                        ${awayLineup.startXI.map(p => `<div class="player-row">${p.player.number || '-'}. ${p.player.name}</div>`).join('')}
                        <h5 style="margin-top:1rem;">Substitutes</h5>
                        ${awayLineup.substitutes.map(p => `<div class="player-row">${p.player.number || '-'}. ${p.player.name}</div>`).join('')}
                    </div>
                </div>`;
        };

        const renderH2H = (h2h) => {
            if (!h2h || h2h.length === 0) return '<p style="text-align:center;padding:2rem;color:var(--text-muted-color);">No previous matches found between these teams.</p>';
            return h2h.map(match => `
                <div class="h2h-match-row">
                    <div class="h2h-date">${new Date(match.fixture.date).toLocaleDateString('en-GB')} - ${match.league.name}</div>
                    <div class="h2h-teams">
                        <span>${match.teams.home.name}</span>
                        <span class="h2h-score">${match.goals.home} - ${match.goals.away}</span>
                        <span>${match.teams.away.name}</span>
                    </div>
                </div>
            `).join('');
        };
        
        // --- AUTH, FAVORITES, NOTIFICATIONS & STANDINGS FUNCTIONS ---
        const loginWithGoogle = () => { window.location.href = `${API_BASE_AUTH}/google`; };
        const loginWithWallet = async () => {
            const msg = document.getElementById('login-message');
            msg.textContent = '';
            try {
                if (typeof window.ethereum === 'undefined') throw new Error('Please install a wallet like MetaMask.');
                showLoading();
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner();
                const address = await signer.getAddress();
                const { nonce } = await fetchDataFromBackend(`${API_BASE_AUTH}/nonce`);
                const message = `Log in to JaguarBet. Nonce: ${nonce}`;
                const signature = await signer.signMessage(message);
                const { token } = await fetchDataFromBackend(`${API_BASE_AUTH}/web3-verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, signature, address }),
                });
                localStorage.setItem('user_token', token);
                await checkForLoggedInUser();
            } catch (error) {
                msg.textContent = `Error: ${error.message}`;
                msg.style.color = 'var(--danger-color)';
            } finally {
                hideLoading();
            }
        };
        const logout = () => {
            localStorage.removeItem('user_token');
            currentUser = null;
            userDbFavorites.clear();
            updateUI();
            updateAllFavoriteIcons();
            renderFavoriteMatches();
        };
        const checkForLoggedInUser = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            if (tokenFromUrl) {
                localStorage.setItem('user_token', tokenFromUrl);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            const storedToken = localStorage.getItem('user_token');
            if (storedToken) {
                const userData = parseJwt(storedToken);
                if (userData && userData.exp * 1000 > Date.now()) {
                    currentUser = userData;
                } else {
                    logout();
                }
            }
            updateUI();
            if (currentUser) {
                await loadUserFavorites();
                const guestFavorites = getGuestFavorites();
                if (guestFavorites.size > 0) {
                    const mergedFavorites = new Set([...guestFavorites, ...userDbFavorites]);
                    if (mergedFavorites.size > userDbFavorites.size) {
                        userDbFavorites = new Set(Array.from(mergedFavorites));
                        await saveFavorites();
                    }
                    localStorage.removeItem('guest_favorites');
                }
                await updateNotificationSwitch();
            }
            updateAllFavoriteIcons();
            renderFavoriteMatches();
        };
        const updateUI = () => {
            const authSection = document.getElementById('auth-section');
            const profileSection = document.getElementById('profile-section');
            if (currentUser) {
                authSection.style.display = 'none';
                profileSection.style.display = 'block';
                const profileName = currentUser.name || (currentUser.address ? 'Wallet User' : 'User');
                document.getElementById('profile-name').textContent = profileName.split(' ')[0];
                document.getElementById('menu-user-name').textContent = profileName;
                document.getElementById('menu-user-email').textContent = currentUser.email || 'No email provided';
                const walletContainer = document.getElementById('menu-wallet-address-container');
                if (currentUser.address) {
                    walletContainer.style.display = 'flex';
                    document.getElementById('menu-wallet-address').textContent = `${currentUser.address.slice(0, 6)}...${currentUser.address.slice(-4)}`;
                } else {
                    walletContainer.style.display = 'none';
                }
            } else {
                authSection.style.display = 'block';
                profileSection.style.display = 'none';
            }
        };
        const toggleProfileMenu = () => {
            const menu = document.getElementById('profile-menu');
            const button = document.getElementById('profile-button');
            const isVisible = menu.style.display === 'block';
            menu.style.display = isVisible ? 'none' : 'block';
            button.classList.toggle('open', !isVisible);
        };
        const loadUserFavorites = async () => {
            const token = localStorage.getItem('user_token');
            if (!token) return;
            try {
                const favs = await fetchDataFromBackend(`${API_BASE_FOOTBALL}/get-favorites`, { headers: { 'Authorization': `Bearer ${token}` } });
                userDbFavorites = new Set(favs.map(Number));
            } catch (error) { console.error('Error loading favorites:', error); }
        };
        const saveFavorites = async () => {
            if (!currentUser) return;
            const token = localStorage.getItem('user_token');
            try {
                await fetchDataFromBackend(`${API_BASE_FOOTBALL}/set-favorites`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(Array.from(userDbFavorites))
                });
            } catch (error) { console.error('Error saving favorites:', error); }
        };
        const toggleFavorite = (fixtureIdStr, event) => {
            event.stopPropagation();
            const fixtureId = parseInt(fixtureIdStr, 10);
            const icon = event.target;
            const favorites = getCurrentFavorites();
            if (favorites.has(fixtureId)) {
                favorites.delete(fixtureId);
            } else {
                favorites.add(fixtureId);
                icon.classList.add('favorite-animate');
                setTimeout(() => icon.classList.remove('favorite-animate'), 300);
            }
            if (currentUser) saveFavorites();
            else saveGuestFavorites(favorites);
            updateAllFavoriteIcons();
            renderFavoriteMatches();
        };
        const showFavoriteAlert = (msg) => {
            const alertDiv = document.getElementById('favorite-alert');
            alertDiv.textContent = msg;
            alertDiv.style.display = 'block';
            setTimeout(() => alertDiv.style.opacity = 1, 10);
            setTimeout(() => {
                alertDiv.style.opacity = 0;
                setTimeout(() => alertDiv.style.display = 'none', 300);
            }, 2000);
        };
        const updateAllFavoriteIcons = () => {
            const favorites = getCurrentFavorites();
            document.querySelectorAll('.favorite-toggle').forEach(icon => {
                const fixtureId = parseInt(icon.dataset.fixtureId, 10);
                icon.classList.toggle('is-favorite', favorites.has(fixtureId));
            });
        };
        const handleNotificationSwitch = async () => {
            const isChecked = document.getElementById('notification-switch').checked;
            try {
                if (isChecked) await subscribeUserToPush();
                else await unsubscribeUserFromPush();
            } catch (error) {
                console.error('Notification switch error:', error);
                document.getElementById('notification-switch').checked = !isChecked;
                showFavoriteAlert('Could not change notification settings.');
            }
        };
        const updateNotificationSwitch = async () => {
            const item = document.getElementById('notification-item');
            if (!('serviceWorker' in navigator) || !('PushManager' in window) || !FCM_VAPID_PUBLIC_KEY) {
                item.style.display = 'none';
                return;
            }
            item.style.display = 'flex';
            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                document.getElementById('notification-switch').checked = subscription !== null;
            } catch (e) {
                console.error("Service worker not ready, could not check notification status.");
                item.style.display = 'none';
            }
        };
        const subscribeUserToPush = async () => {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') throw new Error('Notification permission not granted.');
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(FCM_VAPID_PUBLIC_KEY),
            });
            await fetchDataFromBackend(`${API_BASE_NOTIFICATIONS}/subscribe`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('user_token')}` },
                body: JSON.stringify(subscription),
            });
            showFavoriteAlert('Notifications enabled!');
        };
        const unsubscribeUserFromPush = async () => {
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.getSubscription();
            if (subscription) {
                await fetchDataFromBackend(`${API_BASE_NOTIFICATIONS}/unsubscribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('user_token')}` },
                    body: JSON.stringify({ endpoint: subscription.endpoint }),
                });
                await subscription.unsubscribe();
                showFavoriteAlert('Notifications disabled.');
            }
        };
        const loadLeagues = async () => { /* ... mevcut kod ... */ };
        const loadSeasons = async () => { /* ... mevcut kod ... */ };
        const fetchStandings = async () => { /* ... mevcut kod ... */ };

        // ===================================================================
        //              YENİ VE GÜNCELLENMİŞ WEB3 BÖLÜMÜ
        // ===================================================================

        const jagTokenAddress = "0x745ff1E3699f1273FF63239dC0Ea41781F6330E1";
        const jagWinSoccerAddress = "0x09fd5199F428dF0ac985aaDEb404DD3d12Ab73b3";
        
        const jagTokenABI = [ "function approve(address spender, uint256 amount) returns (bool)", "function allowance(address owner, address spender) view returns (uint256)" ];
        const jagWinSoccerABI = [ "function createPrediction(uint256, uint256, uint256)", "function joinPrediction(uint256)", "function predictions(uint256) view returns (address, uint256, uint256, uint256, uint, uint, uint, uint8, uint8)", "event PredictionCreated(uint256 indexed predictionId, address indexed creator)" ];

        const getSigner = async () => {
            if (!window.ethereum) throw new Error("No crypto wallet found. Please install it.");
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            return provider.getSigner();
        };

        const showPredictionStatus = (message, isError = false) => {
            const statusDiv = document.getElementById('prediction-status');
            if (!statusDiv) return;
            statusDiv.textContent = message;
            statusDiv.style.color = isError ? 'var(--danger-color)' : '#4CAF50';
            statusDiv.style.display = 'block';
        };

        const formatMarket = (market, selection) => {
            const parts = market.split('_');
            const sel = selection.toLowerCase();
            if (parts[0] === 'TOTAL') return `Total Goals ${sel.charAt(0).toUpperCase() + sel.slice(1)} 2.5`;
            if (parts[0] === 'BOTH') return `Both Teams to Score - ${sel.charAt(0).toUpperCase() + sel.slice(1)}`;
            return `${market} - ${selection}`;
        };

        async function createPrediction(fixtureId) {
            if (!currentUser || !currentUser.address) { return showFavoriteAlert("Please log in with your wallet to create a prediction."); }
            
            const marketSelect = document.getElementById('market-type').value.split(':');
            const market = marketSelect[0];
            const selection = marketSelect[1];
            const entryFee = document.getElementById('entry-fee').value;
            const maxParticipants = document.getElementById('max-participants').value;
            const votingDuration = 3 * 24 * 60 * 60; 

            showPredictionStatus("Preparing transaction...", false);

            try {
                const signer = await getSigner();
                const contract = new ethers.Contract(jagWinSoccerAddress, jagWinSoccerABI, signer);
                const entryFeeWei = ethers.utils.parseUnits(entryFee, 18);
                
                let predictionId;
                const listener = (id, creator) => {
                    if (creator.toLowerCase() === currentUser.address.toLowerCase()) {
                        predictionId = id.toNumber();
                        contract.off("PredictionCreated", listener); // Listener'ı kaldır
                    }
                };
                contract.on("PredictionCreated", listener);

                const tx = await contract.createPrediction(entryFeeWei, maxParticipants, votingDuration);
                showPredictionStatus("Waiting for transaction confirmation...", false);
                await tx.wait();
                
                // Event'in yakalanması için kısa bir bekleme süresi
                for(let i=0; i < 5 && predictionId === undefined; i++) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                if (predictionId !== undefined) {
                     await fetchDataFromBackend(`${API_BASE_PREDICTIONS}/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('user_token')}` },
                        body: JSON.stringify({ fixtureId, market, selection, predictionIdOnChain: predictionId }),
                    });
                    showPredictionStatus("Prediction created successfully! ✅", false);
                    loadPredictionsForFixture(fixtureId);
                } else {
                   throw new Error("Could not retrieve prediction ID from the event. Please check the transaction on PolygonScan.");
                }

            } catch (error) {
                console.error("Create Prediction Error:", error);
                showPredictionStatus(`Error: ${error.reason || error.message}`, true);
            }
        }

        async function loadPredictionsForFixture(fixtureId) {
            const container = document.getElementById('prediction-list-container');
            container.innerHTML = `<div class="content-loader"><div class="loader"></div></div>`;

            try {
                const offChainPredictions = await fetchDataFromBackend(`${API_BASE_PREDICTIONS}/list?fixtureId=${fixtureId}`);
                if (offChainPredictions.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color: var(--text-muted-color);">No active predictions for this match yet.</p>';
                    return;
                }
                
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const contract = new ethers.Contract(jagWinSoccerAddress, jagWinSoccerABI, provider);
                
                let html = '';
                for(const pred of offChainPredictions) {
                    const onChainData = await contract.predictions(pred.id);
                    const isFull = onChainData.joinedParticipants.gte(onChainData.maxParticipants);
                    
                    html += `
                        <div class="prediction-item">
                            <div class="prediction-item-header">
                                <span class="prediction-creator">Creator: ${pred.creator_address.slice(0, 6)}...${pred.creator_address.slice(-4)}</span>
                            </div>
                            <div class="prediction-details">
                                ${formatMarket(pred.market_type, pred.selection)}
                            </div>
                            <div class="prediction-meta">
                                <span>Fee: <strong>${ethers.utils.formatUnits(onChainData.entryFee, 18)} JAG</strong></span>
                                <span>Users: <strong>${onChainData.joinedParticipants}/${onChainData.maxParticipants}</strong></span>
                                <button class="btn-join-prediction" onclick="joinPrediction(${pred.id}, '${onChainData.entryFee.toString()}')" ${isFull ? 'disabled' : ''}>
                                    ${isFull ? 'Full' : 'Join'}
                                </button>
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            } catch (error) {
                console.error("Error loading predictions:", error);
                container.innerHTML = `<p style="text-align:center; color: var(--danger-color);">Could not load predictions.</p>`;
            }
        }

        async function joinPrediction(predictionId, entryFeeString) {
            if (!currentUser || !currentUser.address) { return showFavoriteAlert("Please log in with your wallet to join a prediction."); }
            
            showLoading();
            try {
                const signer = await getSigner();
                const userAddress = await signer.getAddress();
                const entryFee = ethers.BigNumber.from(entryFeeString);

                const tokenContract = new ethers.Contract(jagTokenAddress, jagTokenABI, signer);
                const winContract = new ethers.Contract(jagWinSoccerAddress, jagWinSoccerABI, signer);

                showFavoriteAlert("Checking token allowance...");
                const allowance = await tokenContract.allowance(userAddress, jagWinSoccerAddress);
                if (allowance.lt(entryFee)) {
                    showFavoriteAlert("Approval needed. Please confirm in your wallet...");
                    const approveTx = await tokenContract.approve(jagWinSoccerAddress, entryFee); // Sadece gerekli miktar için izin iste
                    await approveTx.wait();
                    showFavoriteAlert("Approval successful! Now joining...");
                }

                showFavoriteAlert("Joining prediction, please confirm...");
                const joinTx = await winContract.joinPrediction(predictionId);
                await joinTx.wait();
                
                showFavoriteAlert("Successfully joined the prediction! 🎉");
                // Tahmin listesini yenile
                const fixtureId = modalBody.querySelector('.modal-tab-button[data-tab="predictions"]')?.dataset.fixtureId;
                if(fixtureId) loadPredictionsForFixture(fixtureId);

            } catch(error) {
                console.error("Join Prediction Error:", error);
                showFavoriteAlert(`Error: ${error.reason || error.message}`);
            } finally {
                hideLoading();
            }
        }

        // --- PAGE INITIALIZATION ---
        const openTab = (event) => {
            const tabName = event.currentTarget.dataset.tab;
            document.querySelectorAll('.tab-content, .tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            if (tabName === 'favorites-tab') renderFavoriteMatches();
        };

        const initializePage = async () => {
            if ('serviceWorker' in navigator) {
                try { await navigator.serviceWorker.register('/service-worker.js'); } catch(err) { console.error('Service Worker registration failed:', err); }
            }
            
            document.getElementById('google-login-btn').addEventListener('click', loginWithGoogle);
            document.getElementById('wallet-login-btn').addEventListener('click', loginWithWallet);
            document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); logout(); });
            document.getElementById('profile-button').addEventListener('click', toggleProfileMenu);
            document.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', openTab));
            document.getElementById('notification-switch').addEventListener('change', handleNotificationSwitch);
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => { if (event.target === modal) closeModal(); });
            window.addEventListener('click', (event) => {
                if (!event.target.closest('#profile-section')) {
                    const menu = document.getElementById('profile-menu');
                    if (menu && menu.style.display === 'block') toggleProfileMenu();
                }
            });

            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('scheduled-date-select').value = today.toISOString().split('T')[0];
            document.getElementById('finished-date-select').value = yesterday.toISOString().split('T')[0];
            
            try {
                const config = await fetchDataFromBackend(API_BASE_CONFIG);
                FCM_VAPID_PUBLIC_KEY = config.vapidPublicKey;
            } catch(e) { console.error('Could not load configuration', e); }

            await checkForLoggedInUser();
            await fetchLiveMatches();
            await loadLeagues();
            await loadSeasons();
            
            liveMatchIntervalId = setInterval(() => fetchLiveMatches(true), 15000);
        };
        
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>